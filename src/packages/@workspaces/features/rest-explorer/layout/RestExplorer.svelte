<script lang="ts">
  // ---- Assets
  import floppyDisk from "$lib/assets/floppy-disk.svg";
  import angleDown from "$lib/assets/angle-down.svg";
  import {
    AdvanceAPI,
    CreateCollection,
    SendingApiRequest,
  } from "@workspaces/features/videos";

  // ---- Components
  import {
    HttpUrlSection,
    RequestHeaders,
    RequestNavigator,
    ResponseNavigator,
    RequestAuth,
    ResponseDefaultScreen,
    ResponseErrorScreen,
    ResponseHeaders,
    ResponseBodyNavigator,
    RequestBody,
    RequestName,
    ResponseBody,
    RestExtensionPanel,
    RequestParameters,
    ResponseStatus,
  } from "@workspaces/features/rest-explorer/components";
  import Loader from "@library/ui/loader/Loader.svelte";
  import ModalWrapperV1 from "@library/ui/modal/Modal.svelte";
  import Dropdown from "$lib/components/dropdown/Dropdown.svelte";
  import { notifications } from "@library/ui/toast/Toast";
  import { Splitpanes, Pane } from "svelte-splitpanes";
  import Button from "@library/ui/button/Button.svelte";

  import type { CollectionDocument } from "@app/database/database";
  import type { Observable } from "rxjs";
  import { SaveAsRequest } from "@workspaces/features";
  import type {
    ClearResponseType,
    CreateCollectionType,
    CreateFolderType,
    ReadCollectionType,
    ReadRequestOrFolderInCollectionType,
    ReadWorkspaceType,
    SaveAsRequestType,
    SaveRequestType,
    SendRequestType,
    UpdateAutoGeneratedHeadersType,
    UpdateHeadersType,
    UpdateParamsType,
    UpdateRequestAuthType,
    UpdateRequestBodyType,
    UpdateRequestDescriptionType,
    UpdateRequestMethodType,
    UpdateRequestNameType,
    UpdateRequestStateType,
    UpdateRequestUrlType,
  } from "@workspaces/common/type";
  import {
    RequestSectionEnum,
    ResponseSectionEnum,
    type KeyValue,
    type RequestTab,
  } from "@common/types/workspace";
  import { requestSplitterDirection } from "../store";
  import Popover from "@library/ui/popover/Popover.svelte";
  import { onMount } from "svelte";
  import { Carousel, Modal } from "@library/ui";

  export let tab: Observable<RequestTab>;
  export let collections: Observable<CollectionDocument[]>;
  export let requestAuthHeader: Observable<KeyValue>;
  export let requestAuthParameter: Observable<KeyValue>;
  export let onUpdateRequestUrl: UpdateRequestUrlType;
  export let onSendRequest: SendRequestType;
  export let onUpdateRequestMethod: UpdateRequestMethodType;
  export let onUpdateRequestParams: UpdateParamsType;
  export let onUpdateRequestName: UpdateRequestNameType;
  export let onUpdateRequestBody: UpdateRequestBodyType;
  export let onUpdateRequestAuth: UpdateRequestAuthType;
  export let onUpdateHeaders: UpdateHeadersType;
  export let onUpdateAutoGeneratedHeaders: UpdateAutoGeneratedHeadersType;
  export let onUpdateRequestState: UpdateRequestStateType;
  export let onClearResponse: ClearResponseType;
  export let onSaveRequest: SaveRequestType;
  export let onUpdateRequestDescription: UpdateRequestDescriptionType;
  export let readRequestOrFolderInCollection: ReadRequestOrFolderInCollectionType;
  export let readCollection: ReadCollectionType;
  export let readWorkspace: ReadWorkspaceType;
  export let onSaveAsRequest: SaveAsRequestType;
  export let onCreateFolder: CreateFolderType;
  export let onCreateCollection: CreateCollectionType;
  export let onUpdateEnvironment;
  export let environmentVariables;
  export let showContainer = true;
  export let onFetchCollectionGuide;
  export let onUpdateCollectionGuide;

  onMount(async () => {
    const event = await onFetchCollectionGuide();
    event.$.subscribe((e) => {
      if (e.isActive === false) {
        showContainer = false;
      } else {
        showContainer = true;
      }
    });
  });
  export let onRenameCollection;
  export let onRenameFolder;

  let isExposeSaveAsRequest = false;
  let isLoading = true;
  $: {
    if ($tab?.property?.request?.url?.length > 0) {
      isLoading = false;
    }
  }
  const toggleSaveRequest = (flag: boolean): void => {
    isExposeSaveAsRequest = flag;
  };
  let isGuidePopup = false;
</script>

{#if $tab.tabId}
  <div class="d-flex rest-explorer-layout">
    <div class="w-100 d-flex flex-column h-100 p-3">
      <!-- Request Name Header -->
      <!-- 
        --
        -- Rest name header is set to display none 
        --
      -->
      <div class="d-flex justify-content-between w-100 p-3 d-none">
        <RequestName name={$tab.name} {onUpdateRequestName} />

        <div class="d-flex justify-content-between">
          <Button
            title="Save Request"
            type="dark"
            loader={false}
            buttonClassProp="ms-2"
            buttonStartIcon={floppyDisk}
            onClick={async () => {
              const x = await onSaveRequest();
              if (
                x.status === "error" &&
                x.message ===
                  "request is not a part of any workspace or collection"
              ) {
                isExposeSaveAsRequest = true;
              } else if (x.status === "success") {
                notifications.success("API request saved");
              }
            }}
          />

          <span class="position-relative" style="width:35px;">
            <Dropdown
              disabled={false}
              dropdownId={"saveAsDropdown"}
              dropDownType={{ type: "img", title: angleDown }}
              data={[
                {
                  name: "Save As",
                  id: "collection",
                  dynamicClasses: "text-whiteColor",
                },
              ]}
              onclick={() => {
                isExposeSaveAsRequest = true;
              }}
              staticCustomStyles={[
                {
                  id: "saveAsDropdown-options-container",
                  styleKey: "minWidth",
                  styleValue: "180px",
                },
              ]}
              staticClasses={[
                {
                  id: "saveAsDropdown-img",
                  classToAdd: ["btn", "bg-dullBackground", "px-2", "py-1"],
                },
                {
                  id: "saveAsDropdown-options-name",
                  classToAdd: ["fs-6"],
                },
                {
                  id: "saveAsDropdown-options-container",
                  classToAdd: ["end-0", "mt-1", "rounded"],
                },
              ]}
            ></Dropdown>
          </span>
          <Button
            title="Share"
            type="dark"
            buttonClassProp="ms-2"
            onClick={() => {}}
          />
        </div>
      </div>
      <div class="">
        {#if showContainer}
          <Popover
            onClose={() => {
              showContainer = false;
              onUpdateCollectionGuide(false);
            }}
            heading={`Welcome to Sparrow!`}
            text={` `}
          >
            <p>
              Your one-stop solution for API testing and management. Start
              organizing your API requests into collections, utilize environment
              variables, and streamline your development process. Get started
              now by creating your first collection or exploring our features
              <span
                on:click={() => {
                  isGuidePopup = true;
                }}
                class="link btn p-0 border-0"
                style="font-size: 12px;"
                >See how it works.
              </span>
            </p>
          </Popover>
        {/if}
      </div>

      <!-- HTTP URL Section -->
      <HttpUrlSection
        class=""
        isSave={$tab.isSaved}
        requestUrl={$tab.property.request.url}
        httpMethod={$tab.property.request.method}
        isSendRequestInProgress={$tab.property.request?.state
          ?.isSendRequestInProgress}
        onSendButtonClicked={onSendRequest}
        {onUpdateEnvironment}
        {environmentVariables}
        {onUpdateRequestUrl}
        {onUpdateRequestMethod}
        {toggleSaveRequest}
        {onSaveRequest}
      />
      {#if !isLoading}
        <Splitpanes
          class="rest-splitter w-100"
          id={"rest-splitter"}
          style="height: calc(100vh - 160px); margin-top:10px;"
          horizontal={$requestSplitterDirection === "horizontal" ? true : false}
          dblClickSplitter={false}
          on:resize={(e) => {
            onUpdateRequestState({
              requestLeftSplitterWidthPercentage: e.detail[0].size,
            });
            onUpdateRequestState({
              requestRightSplitterWidthPercentage: e.detail[1].size,
            });
          }}
        >
          <Pane
            minSize={30}
            size={$tab.property.request?.state
              ?.requestLeftSplitterWidthPercentage}
            class="position-relative bg-secondary-800-important"
          >
            <!-- Request Pane -->
            <div
              class="h-100 position-relative {$requestSplitterDirection ===
              'horizontal'
                ? 'pb-3'
                : 'pe-3'}"
            >
              <RequestNavigator
                requestStateSection={$tab.property.request?.state
                  ?.requestNavigation}
                {onUpdateRequestState}
                authParameterLength={$requestAuthParameter.value ? 1 : 0}
                authHeaderLength={$requestAuthHeader.value ? 1 : 0}
                paramsLength={$tab.property?.request?.queryParams?.length || 0}
                headersLength={$tab.property?.request?.headers?.length || 0}
                autoGeneratedHeadersLength={$tab.property?.request
                  ?.autoGeneratedHeaders?.length || 0}
              />
              {#if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.PARAMETERS}
                <RequestParameters
                  params={$tab.property.request.queryParams}
                  {onUpdateRequestParams}
                  authParameter={$requestAuthParameter}
                  {onUpdateEnvironment}
                  {environmentVariables}
                />
              {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.REQUEST_BODY}
                <RequestBody
                  body={$tab.property.request.body}
                  method={$tab.property.request.method}
                  requestState={$tab.property.request.state}
                  {onUpdateRequestBody}
                  {onUpdateRequestState}
                  {onUpdateEnvironment}
                  {environmentVariables}
                />
              {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.HEADERS}
                <RequestHeaders
                  {environmentVariables}
                  {onUpdateEnvironment}
                  headers={$tab.property.request.headers}
                  autoGeneratedHeaders={$tab.property.request
                    .autoGeneratedHeaders}
                  authHeader={$requestAuthHeader}
                  onHeadersChange={onUpdateHeaders}
                  onAutoGeneratedHeadersChange={onUpdateAutoGeneratedHeaders}
                />
              {:else if $tab.property.request?.state?.requestNavigation === RequestSectionEnum.AUTHORIZATION}
                <RequestAuth
                  requestStateAuth={$tab.property.request.state
                    .requestAuthNavigation}
                  {onUpdateRequestState}
                  auth={$tab.property.request.auth}
                  {onUpdateRequestAuth}
                  {onUpdateEnvironment}
                  {environmentVariables}
                />
              {/if}
            </div>
          </Pane>
          <Pane
            minSize={30}
            size={$tab.property.request?.state
              ?.requestRightSplitterWidthPercentage}
            class="bg-secondary-800-important"
          >
            <!-- Response Pane -->
            <div
              class="d-flex position-relative flex-column h-100 {$requestSplitterDirection ===
              'horizontal'
                ? 'pt-3'
                : 'ps-3'}"
            >
              {#if $tab.property.request?.state?.isSendRequestInProgress}
                <ResponseDefaultScreen />
                <div
                  style="top: 10px; left: 0; right: 0; bottom: 0; z-index:3; position:absolute;"
                >
                  <Loader loaderSize={"20px"} />
                </div>
              {:else if !$tab.property.request?.response?.status}
                <ResponseDefaultScreen />
              {:else if $tab.property.request?.response?.status === "Not Found"}
                <ResponseErrorScreen />
              {:else if $tab.property.request?.response?.status}
                <ResponseStatus response={$tab.property.request.response} />
                <ResponseNavigator
                  requestStateSection={$tab.property.request.state
                    ?.responseNavigation}
                  {onUpdateRequestState}
                  responseHeadersLength={$tab.property?.request?.response
                    ?.headers?.length || 0}
                />
                {#if $tab.property.request.state?.responseNavigation === ResponseSectionEnum.RESPONSE}
                  {#if $tab.property.request.state?.responseBodyLanguage !== "Image"}
                    <ResponseBodyNavigator
                      response={$tab.property.request.response}
                      apiState={$tab.property.request.state}
                      {onUpdateRequestState}
                      {onClearResponse}
                    />
                  {/if}
                  <ResponseBody
                    response={$tab.property.request.response}
                    apiState={$tab.property.request.state}
                  />
                {:else if $tab.property.request.state?.responseNavigation === ResponseSectionEnum.HEADERS}
                  <ResponseHeaders
                    responseHeader={$tab.property.request.response.headers}
                  />
                {/if}
              {/if}
            </div></Pane
          >
        </Splitpanes>
      {:else}
        <!-- loading state -->
        <ResponseDefaultScreen isMainScreen={true} />
      {/if}
    </div>
    <!--
      --
       -- Rest extension panel is set to display none 
      --
    -->
    <div class="d-none">
      <RestExtensionPanel
        state={$tab.property.request?.state}
        requestMethod={$tab.property.request?.method}
        requestUrl={$tab.property.request?.url}
        requestName={$tab.name}
        requestDescription={$tab.description}
        requestPath={$tab.path}
        collections={$collections}
        {onSaveRequest}
        {readCollection}
        {readWorkspace}
        {onSaveAsRequest}
        {onCreateFolder}
        {onCreateCollection}
        {onUpdateRequestState}
        {onUpdateRequestDescription}
        {readRequestOrFolderInCollection}
      />
    </div>
  </div>
  <ModalWrapperV1
    title={"Save Request"}
    type={"dark"}
    width={"55%"}
    zIndex={10000}
    isOpen={isExposeSaveAsRequest}
    handleModalState={(flag = false) => {
      isExposeSaveAsRequest = flag;
    }}
  >
    <SaveAsRequest
      onClick={(flag = false) => {
        isExposeSaveAsRequest = flag;
      }}
      requestMethod={$tab.property.request?.method}
      requestUrl={$tab.property.request?.url}
      requestName={$tab.name}
      requestDescription={$tab.description}
      requestPath={$tab.path}
      collections={$collections}
      {readWorkspace}
      {onSaveAsRequest}
      {onCreateFolder}
      {onCreateCollection}
      {onRenameCollection}
      {onRenameFolder}
    />
  </ModalWrapperV1>
{/if}
<Modal
  title={""}
  type={"dark"}
  width={"474px"}
  zIndex={10000}
  isOpen={isGuidePopup}
  handleModalState={(flag = false) => {
    isGuidePopup = flag;
  }}
>
  <div style="position: relative;">
    <Carousel
      handleClosePopup={(flag = false) => {
        isGuidePopup = flag;
      }}
      data={[
        {
          id: 1,
          heading: "Creating a Collection: Import existing or Start a new one",
          subheading: `Organize your APIs efficiently within "Collections" for streamlined API management and testing. Click the + Add Collection button in the side panel to create a collection. Choose 'Import Collection' to bring in existing API collections or create an empty Collection. `,
          gif: `${CreateCollection}`,
        },
        {
          id: 2,
          heading: "Sending an API Request",
          subheading:
            "In the request builder, input your API endpoint URL in the URL field. Click the 'Send' button to dispatch the request. Instantly see the server's response, which includes status codes, response time, and data.",
          gif: `${SendingApiRequest}`,
        },
        {
          id: 3,
          heading: "Advanced API Request with Detailed Inputs",
          subheading:
            "Enter the endpoint URL in the URL field. Utilize 'Parameters' tab for parameters, 'Body' tab to input data payloads, 'Headers' tab for custom headers, and 'Auth' tab to manage access credentials. After filling in the required fields, click 'Send' to execute the request and view the detailed server response.",
          gif: `${AdvanceAPI}`,
        },
      ]}
    />
  </div>
</Modal>

<style>
  .rest-explorer-layout {
    background-color: var(--bg-secondary-800);
    height: calc(100vh - 80px);
  }

  :global(.rest-splitter.splitpanes--vertical .splitpanes__splitter) {
    width: 10.5px !important;
    height: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-left: 5px solid var(--border-secondary-800) !important;
    border-right: 5px solid var(--border-secondary-800) !important;
    border-top: 0 !important;
    border-bottom: 0 !important;
  }
  :global(.rest-splitter.splitpanes--horizontal .splitpanes__splitter) {
    height: 10.5px !important;
    width: 100% !important;
    background-color: var(--bg-secondary-500) !important;
    border-top: 5px solid var(--border-secondary-800) !important;
    border-bottom: 5px solid var(--border-secondary-800) !important;
    border-left: 0 !important;
    border-right: 0 !important;
  }
  :global(
      .rest-splitter .splitpanes__splitter:active,
      .rest-splitter .splitpanes__splitter:hover
    ) {
    background-color: var(--bg-primary-200) !important;
  }
  .link {
    color: var(--bg-primary-300);
    text-decoration: underline;
  }
</style>
